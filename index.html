<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trius Books</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <h1>Trius Books</h1>
        <p class="site-description">íŠ¸ë¦¬ìš°ìŠ¤ ë¼ìš´ì§€ì— êµ¬ë¹„ëœ ë„ì„œ ëª©ë¡ì…ë‹ˆë‹¤.<br>ê°œì¸ì ìœ¼ë¡œ ë§Œë“  ê²ƒì´ì§€ë§Œ ì…ì£¼ë¯¼ë“¤ê»˜ ë„ì›€ë˜ê¸¸ ë°”ëë‹ˆë‹¤ ğŸ˜€</p>

        <div class="search-section">
            <form class="search-form" onsubmit="applyFilters(event)">
                <div class="search-input-group">
                    <input type="text" id="searchInput" name="query" placeholder="ğŸ”  ë„ì„œëª…, ì €ì, í‚¤ì›Œë“œë¡œ ê²€ìƒ‰" value="">
                    <button type="submit" aria-label="ë„ì„œ ê²€ìƒ‰">ê²€ìƒ‰</button>
                </div>
            </form>
        </div>

        <div class="button-group">
            <a href="trius_book_list.csv" class="download-btn" download>ğŸ“¥ ì „ì²´ëª©ë¡ ë‹¤ìš´ë¡œë“œ</a>
            <button type="button" class="upload-btn" id="upload-info-btn" onclick="showUploadInfo()">ë„ì„œ ì—…ë°ì´íŠ¸ ë°©ë²•</button>
            <button type="button" class="search-download-btn" id="search-download-btn" onclick="downloadSearchResults()"
                style="display: none;">ğŸ“‹ ê²€ìƒ‰ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
        </div>



        <div class="books-list">
            <div class="table-container">
                <table role="table" aria-label="ë„ì„œ ëª©ë¡">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable(0)" aria-label="ë²ˆí˜¸ë¡œ ì •ë ¬">ë²ˆí˜¸ <span
                                    class="sort-icon">â–¼</span></th>
                            <th class="sortable" onclick="sortTable(1)" aria-label="ë„ì„œëª…ìœ¼ë¡œ ì •ë ¬">ë„ì„œëª… <span
                                    class="sort-icon">â–¼</span></th>
                            <th class="sortable" onclick="sortTable(2)" aria-label="ì €ìë¡œ ì •ë ¬">ì €ì <span
                                    class="sort-icon">â–¼</span></th>
                            <th class="category-header">
                                <div class="category-filter-container">
                                    <span id="category-header-text">ë¶„ë¥˜</span> <span class="filter-icon">â–¼</span>
                                    <select id="category-filter" onchange="applyFilters()">
                                        <option value="">ë¶„ë¥˜</option>
                                    </select>
                                </div>
                            </th>
                            <th class="sortable" onclick="sortTable(4)" aria-label="ì¶”ì²œ ëŒ€ìƒìœ¼ë¡œ ì •ë ¬">ì¶”ì²œ <span
                                    class="sort-icon">â–¼</span></th>
                        </tr>
                    </thead>
                    <tbody id="books-table-body">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem; color: #7f8c8d;">
                                ğŸ“š ë„ì„œ ëª©ë¡ì„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="pagination-container"></div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p class="copyright">Â© 2026 Trius Books. All rights reserved.</p>
        </div>
    </footer>

    <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
    <div id="preview-modal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closePreviewModal()"></div>
        <div class="modal-content preview-modal-content">
            <button class="modal-close-simple" onclick="closePreviewModal()" aria-label="ëª¨ë‹¬ ë‹«ê¸°">âœ•</button>

            <div class="modal-body-full">
                <div class="preview-content" id="preview-content">
                    <!-- ìƒì„±ëœ HTML ë¯¸ë¦¬ë³´ê¸° iframe -->
                </div>
            </div>

            <div class="modal-footer-compact">
                <button class="btn-download" onclick="confirmDownload()">
                    ğŸ’¾ ë‹¤ìš´ë¡œë“œ
                </button>
                <button class="btn-print-green" onclick="printPreview()">
                    ğŸ–¨ï¸ ì¶œë ¥í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <script>
        let booksData = [];
        let currentSortColumn = -1;
        let sortAscending = true;
        let currentPage = 1;
        let itemsPerPage = 30;
        let filteredBooks = [];
        let isSearchActive = false;
        let currentSearchQuery = '';
        let currentCategoryFilter = '';

        // í˜ì´ì§€ ë¡œë“œ ì‹œ CSV ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', function () {
            loadCSVData();
        });

        // CSV íŒŒì¼ì—ì„œ ë°ì´í„° ë¡œë“œ
        async function loadCSVData() {
            try {
                const response = await fetch('trius_book_list.csv');
                const csvText = await response.text();

                if (csvText.trim()) {
                    parseCSV(csvText);
                    populateCategoryFilter(); // ë¶„ë¥˜ í•„í„° ì´ˆê¸°í™”
                    filteredBooks = [...booksData];
                    displayBooksWithPagination();
                } else {
                    showNoResults('CSV íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('CSV ë¡œë”© ì˜¤ë¥˜:', error);
                showNoResults('ë„ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // CSV í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ì—¬ ë°°ì—´ë¡œ ë³€í™˜
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

            booksData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length >= headers.length) {
                    const book = {};
                    headers.forEach((header, index) => {
                        book[header] = values[index] || '';
                    });
                    booksData.push(book);
                }
            }
        }

        // ë¶„ë¥˜ í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
        function populateCategoryFilter() {
            const categories = new Set();
            booksData.forEach(book => {
                if (book['ë¶„ë¥˜']) {
                    categories.add(book['ë¶„ë¥˜'].trim());
                }
            });

            const sortedCategories = Array.from(categories).sort();
            const filterSelect = document.getElementById('category-filter');

            // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™” (ì „ì²´ -> ë¶„ë¥˜)
            filterSelect.innerHTML = '<option value="">ë¶„ë¥˜</option>';

            sortedCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                filterSelect.appendChild(option);
            });
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ê³¼ í•¨ê»˜ ë„ì„œ ëª©ë¡ í‘œì‹œ
        function displayBooksWithPagination() {
            const totalPages = Math.ceil(filteredBooks.length / itemsPerPage);

            if (currentPage > totalPages) {
                currentPage = 1;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const booksToShow = filteredBooks.slice(startIndex, endIndex);

            displayBooks(booksToShow, startIndex);
            createPagination(totalPages);
        }

        // ê²€ìƒ‰ ê²°ê³¼ ì •ë³´ ì—…ë°ì´íŠ¸


        // ë„ì„œ ëª©ë¡ì„ í…Œì´ë¸”ì— í‘œì‹œ
        function displayBooks(books, startIndex = 0) {
            const tbody = document.getElementById('books-table-body');

            if (books.length === 0) {
                showNoResults('ğŸ”  ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            tbody.innerHTML = '';
            books.forEach((book, index) => {
                const row = tbody.insertRow();
                const actualIndex = startIndex + index;
                row.setAttribute('data-book-index', actualIndex);
                row.setAttribute('id', `book-row-${actualIndex}`);

                // ì¶”ì²œëŒ€ìƒ ì²˜ë¦¬
                const recommendation = book['ì¶”ì²œ ëŒ€ìƒ'] || '';
                const recommendationHtml = createRecommendationHtml(recommendation, actualIndex);

                row.innerHTML = `
                    <td>${book['ë²ˆí˜¸'] || ''}</td>
                    <td>${book['ë„ì„œëª…'] || ''}</td>
                    <td>${book['ì €ì'] || ''}</td>
                    <td>${book['ë¶„ë¥˜'] || ''}</td>
                    <td class="recommendation-cell">${recommendationHtml}</td>
                `;
            });
        }

        // ê²°ê³¼ ì—†ìŒ ë©”ì‹œì§€ í‘œì‹œ
        function showNoResults(message) {
            const tbody = document.getElementById('books-table-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 2rem; color: #7f8c8d;">
                        ${message}
                    </td>
                </tr>
            `;
        }



        // í†µí•© í•„í„° ì ìš© (ê²€ìƒ‰ì–´ + ì¹´í…Œê³ ë¦¬)
        function applyFilters(event) {
            if (event) event.preventDefault();
            const searchInput = document.getElementById('searchInput');
            const query = searchInput ? searchInput.value.toLowerCase().trim() : '';

            const categorySelect = document.getElementById('category-filter');
            const selectedCategory = categorySelect ? categorySelect.value : '';

            updateCategoryHeader(selectedCategory);

            filteredBooks = booksData.filter(book => {
                // 1. ì¹´í…Œê³ ë¦¬ í•„í„° í™•ì¸
                const categoryMatch = selectedCategory === '' || (book['ë¶„ë¥˜'] && book['ë¶„ë¥˜'].trim() === selectedCategory);
                if (!categoryMatch) return false;

                // 2. ê²€ìƒ‰ì–´ í™•ì¸ (ì¹´í…Œê³ ë¦¬ê°€ ë§ìœ¼ë©´ ê²€ìƒ‰ì–´ë„ í™•ì¸)
                if (!query) return true;

                return (book['ë„ì„œëª…'] && book['ë„ì„œëª…'].toLowerCase().includes(query)) ||
                    (book['ì €ì'] && book['ì €ì'].toLowerCase().includes(query)) ||
                    (book['ë¶„ë¥˜'] && book['ë¶„ë¥˜'].toLowerCase().includes(query)) ||
                    (book['ì¶”ì²œ ëŒ€ìƒ'] && book['ì¶”ì²œ ëŒ€ìƒ'].toLowerCase().includes(query));
            });

            currentPage = 1;
            isSearchActive = !!query || !!selectedCategory;
            currentSearchQuery = query;
            currentCategoryFilter = selectedCategory; // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ (í•„ìš”ì‹œ ì‚¬ìš©)

            toggleButtons();
            displayBooksWithPagination();
        }

        // ì¹´í…Œê³ ë¦¬ í—¤ë” í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ë§ì¤„ì„í‘œ ë¡œì§)
        function updateCategoryHeader(selectedCategory) {
            const headerText = document.getElementById('category-header-text');

            if (!selectedCategory) {
                headerText.textContent = 'ë¶„ë¥˜';
            } else {
                if (selectedCategory.length > 2) {
                    headerText.textContent = selectedCategory.substring(0, 2) + '...';
                } else {
                    headerText.textContent = selectedCategory;
                }
            }
        }

        // í…Œì´ë¸” ì •ë ¬ ê¸°ëŠ¥
        function sortTable(columnIndex) {
            if (currentSortColumn === columnIndex) {
                sortAscending = !sortAscending;
            } else {
                currentSortColumn = columnIndex;
                sortAscending = true;
            }

            const columnNames = ['ë²ˆí˜¸', 'ë„ì„œëª…', 'ì €ì', 'ë¶„ë¥˜', 'ì¶”ì²œ ëŒ€ìƒ'];
            const columnName = columnNames[columnIndex];

            filteredBooks.sort((a, b) => {
                let aVal = a[columnName] || '';
                let bVal = b[columnName] || '';

                // ë²ˆí˜¸ ì»¬ëŸ¼ì¸ ê²½ìš° ìˆ«ìë¡œ ë¹„êµ
                if (columnIndex === 0) {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                } else {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (aVal < bVal) return sortAscending ? -1 : 1;
                if (aVal > bVal) return sortAscending ? 1 : -1;
                return 0;
            });

            currentPage = 1;
            displayBooksWithPagination();

            // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            updateSortIcons(columnIndex);
        }

        // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
        function updateSortIcons(activeColumn) {
            const headers = document.querySelectorAll('th.sortable .sort-icon');
            headers.forEach((icon, index) => {
                if (index === activeColumn) {
                    icon.textContent = sortAscending ? 'â–²' : 'â–¼';
                } else {
                    icon.textContent = 'â–¼'; // Default state is triangle
                    icon.style.opacity = '0.3'; // Dim inactive icons
                }
                if (index === activeColumn) icon.style.opacity = '1';
            });
        }

        // ì¶”ì²œëŒ€ìƒ HTML ìƒì„± (í…ìŠ¤íŠ¸ ì œí•œ + ë”ë³´ê¸° ë²„íŠ¼)
        function createRecommendationHtml(text, index) {
            if (!text) return '';

            // ëª¨ë“  ì¶”ì²œëŒ€ìƒì„ [ë³´ê¸°] ë²„íŠ¼ìœ¼ë¡œ í‘œì‹œ
            return `<button class="more-btn" data-index="${index}" data-text="${text.replace(/"/g, '&quot;')}" onclick="toggleRecommendation(this)">ë³´ê¸°</button>`;
        }

        // í˜„ì¬ í™•ì¥ëœ í–‰ ì¶”ì 
        let currentExpandedRow = null;

        // í…ìŠ¤íŠ¸ë¥¼ ê· ë“±í•œ ê¸¸ì´ë¡œ ë‚˜ëˆ„ëŠ” í•¨ìˆ˜
        function balanceTextLines(text) {
            if (text.length < 60) {
                return text; // ì§§ì€ í…ìŠ¤íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ë°˜í™˜
            }

            const words = text.split(' ');
            const totalLength = text.length;

            // 2-3ì¤„ë¡œ ë‚˜ëˆ„ê¸° ìœ„í•œ ëª©í‘œ ì¤„ ê¸¸ì´ ê³„ì‚°
            let targetLines = totalLength > 120 ? 3 : 2;
            let idealLineLength = Math.floor(totalLength / targetLines);

            let lines = [];
            let currentLine = '';

            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                const testLine = currentLine + (currentLine ? ' ' : '') + word;

                // ë‚¨ì€ ë‹¨ì–´ë“¤ ê³„ì‚°
                const remainingWords = words.slice(i + 1);
                const remainingText = remainingWords.join(' ');
                const remainingLines = targetLines - lines.length - 1; // í˜„ì¬ ì¤„ ì œì™¸

                // ì¤„ë°”ê¿ˆ ì¡°ê±´ ê°œì„ 
                let shouldBreak = false;

                if (remainingLines > 0) {
                    const avgRemainingLength = remainingText.length / remainingLines;

                    // í˜„ì¬ ì¤„ì´ ì´ìƒì  ê¸¸ì´ì— ê°€ê¹ê³ , ë‚¨ì€ í…ìŠ¤íŠ¸ë„ ì ì ˆíˆ ë¶„ë°°ë  ìˆ˜ ìˆì„ ë•Œ
                    if (testLine.length >= idealLineLength * 0.8 &&
                        remainingText.length > idealLineLength * 0.6 &&
                        avgRemainingLength >= idealLineLength * 0.7 &&
                        avgRemainingLength <= idealLineLength * 1.4) {
                        shouldBreak = true;
                    }

                    // ë„ˆë¬´ ê¸´ ì¤„ ë°©ì§€ (ì´ìƒì  ê¸¸ì´ì˜ 1.3ë°°ë¥¼ ë„˜ìœ¼ë©´ ê°•ì œ ì¤„ë°”ê¿ˆ)
                    if (testLine.length > idealLineLength * 1.3 && remainingText.length > 20) {
                        shouldBreak = true;
                    }
                }

                if (shouldBreak && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            }

            // ë§ˆì§€ë§‰ ì¤„ ì¶”ê°€
            if (currentLine) {
                lines.push(currentLine);
            }

            // ê²°ê³¼ê°€ 1ì¤„ì´ë©´ ë‹¤ì‹œ ì‹œë„ (ë” ì§§ì€ ì„ê³„ê°’ìœ¼ë¡œ)
            if (lines.length === 1 && totalLength > 80) {
                return balanceTextLinesAggressive(text);
            }

            return lines.join('<br>');
        }

        // ë” ì ê·¹ì ì¸ ì¤„ ë‚˜ëˆ„ê¸° í•¨ìˆ˜
        function balanceTextLinesAggressive(text) {
            const words = text.split(' ');
            const totalLength = text.length;
            let targetLines = totalLength > 120 ? 3 : 2;
            let idealLineLength = Math.floor(totalLength / targetLines);

            let lines = [];
            let currentLine = '';

            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                const testLine = currentLine + (currentLine ? ' ' : '') + word;

                // ë” ì ê·¹ì ì¸ ì¡°ê±´ìœ¼ë¡œ ì¤„ë°”ê¿ˆ
                if (currentLine && testLine.length > idealLineLength * 0.7 && i < words.length - 2) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            }

            if (currentLine) {
                lines.push(currentLine);
            }

            return lines.join('<br>');
        }

        // ì¶”ì²œëŒ€ìƒ í† ê¸€ ê¸°ëŠ¥ (ìƒˆë¡œìš´ í–‰ ìƒì„±)
        function toggleRecommendation(buttonElement) {
            const targetRow = buttonElement.closest('tr');
            const text = buttonElement.getAttribute('data-text').replace(/&quot;/g, '"');

            if (!targetRow) return;

            // ì´ì „ì— ì—´ë¦° ì¶”ì²œëŒ€ìƒ í–‰ì´ ìˆìœ¼ë©´ ë‹«ê¸°
            if (currentExpandedRow && currentExpandedRow !== targetRow) {
                closeRecommendation();
            }

            // í˜„ì¬ í–‰ì— ì´ë¯¸ ì¶”ì²œëŒ€ìƒì´ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸
            const nextRow = targetRow.nextElementSibling;
            if (nextRow && nextRow.classList.contains('recommendation-row')) {
                // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
                closeRecommendation();
                return;
            }

            // í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ì‚¬ìš© (CSS ì–‘ìª½ ì •ë ¬ ì ìš©)
            const balancedText = text;

            // ìƒˆë¡œìš´ ì¶”ì²œëŒ€ìƒ í–‰ ìƒì„±
            const tbody = targetRow.parentNode;
            const newRowIndex = Array.from(tbody.children).indexOf(targetRow) + 1;
            const recommendationRow = tbody.insertRow(newRowIndex);
            recommendationRow.classList.add('recommendation-row');
            recommendationRow.innerHTML = `
                <td colspan="5" class="recommendation-content">
                    <div class="recommendation-detail">
                        ${balancedText}
                    </div>
                </td>
            `;

            // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ ì´ˆê¸° ë†’ì´ ì„¤ì •
            recommendationRow.style.height = '0';
            recommendationRow.style.opacity = '0';

            // ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
            setTimeout(() => {
                recommendationRow.style.transition = 'all 0.3s ease';
                recommendationRow.style.height = 'auto';
                recommendationRow.style.opacity = '1';
            }, 10);

            buttonElement.textContent = 'ë‹«ê¸°';
            buttonElement.classList.add('close-btn');
            currentExpandedRow = targetRow;
        }

        // ì¶”ì²œëŒ€ìƒ í–‰ ë‹«ê¸°
        function closeRecommendation() {
            if (currentExpandedRow) {
                // ëª¨ë“  ì¶”ì²œëŒ€ìƒ í–‰ ì°¾ì•„ì„œ ì œê±°
                const recommendationRows = document.querySelectorAll('.recommendation-row');
                recommendationRows.forEach(row => {
                    row.style.transition = 'all 0.3s ease';
                    row.style.height = '0';
                    row.style.opacity = '0';

                    setTimeout(() => {
                        if (row.parentNode) {
                            row.parentNode.removeChild(row);
                        }
                    }, 300);
                });

                // ëª¨ë“  [ë‹«ê¸°] ë²„íŠ¼ì„ [ë³´ê¸°]ë¡œ ë³€ê²½
                const closeButtons = document.querySelectorAll('.more-btn');
                closeButtons.forEach(btn => {
                    if (btn.textContent === 'ë‹«ê¸°') {
                        btn.textContent = 'ë³´ê¸°';
                        btn.classList.remove('close-btn');
                    }
                });

                currentExpandedRow = null;
            }
        }

        // ì—…ë¡œë“œ ì •ë³´ í‘œì‹œ
        function showUploadInfo() {
            alert('ë„ì„œëª©ë¡ì„ ì—…ë°ì´íŠ¸ í•˜ëŠ” ë°©ë²•:\n\n' +
                '1. CSV íŒŒì¼ì„ trius_book_list.csvë¡œ ì €ì¥í•´ ì£¼ì„¸ìš”.\n' +
                '2. íŒŒì¼ì€ ë‹¤ìŒ ì»¬ëŸ¼ì„ ìˆœì„œëŒ€ë¡œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:\n' +
                '   - ë²ˆí˜¸, ë„ì„œëª…, ì €ì, ë¶„ë¥˜, ì¶”ì²œ ëŒ€ìƒ\n' +
                '3. GitHubì—ì„œ ì§ì ‘ íŒŒì¼ì„ êµì²´í•´ ì£¼ì„¸ìš”.\n\n' +
                'ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ë©´ dooook@gmail.com ìœ¼ë¡œ ë©”ì¼ ì£¼ì„¸ìš”');
        }

        // ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
        function toggleButtons() {
            const uploadBtn = document.getElementById('upload-info-btn');
            const searchDownloadBtn = document.getElementById('search-download-btn');

            if (isSearchActive) {
                uploadBtn.style.display = 'none';
                searchDownloadBtn.style.display = 'inline-flex';
            } else {
                uploadBtn.style.display = 'inline-flex';
                searchDownloadBtn.style.display = 'none';
            }
        }

        // ê²€ìƒ‰ê²°ê³¼ ë‹¤ìš´ë¡œë“œ - ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
        function downloadSearchResults() {
            if (!isSearchActive || filteredBooks.length === 0) {
                showModal('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            showPreviewModal();
        }

        // HTML ì½˜í…ì¸  ìƒì„± (ë¶„ë¦¬ëœ í•¨ìˆ˜)
        function generateDownloadHTML() {
            const today = new Date();
            const dateStr = `${today.getFullYear()}ë…„ ${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`;

            // HTML ì½˜í…ì¸  ìƒì„±
            let content = `<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŠ¸ë¦¬ìš°ìŠ¤ ë„ì„œ ê²€ìƒ‰ê²°ê³¼ - ${currentSearchQuery}</title>
    <style>
        body {
            font-family: 'Malgun Gothic', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2c3e50;
        }
        .book-list {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .book-item {
            border-bottom: 1px solid #ecf0f1;
            padding: 1.5rem 0;
            display: flex;
            gap: 1rem;
        }
        .book-item:last-child {
            border-bottom: none;
        }
        .book-number {
            color: #34495e;
            font-weight: bold;
            font-size: 1.1rem;
            min-width: 30px;
        }
        .book-content {
            flex: 1;
        }
        .book-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        .book-meta {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .book-recommendation {
            color: #34495e;
            font-size: 0.9rem;
            background: #f8f9fa;
            padding: 0.8rem;
            border-radius: 8px;
            border-left: 4px solid #34495e;
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .title {
            color: #34495e;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        .subtitle {
            color: #7f8c8d;
            font-size: 1rem;
        }
        .footer {
            text-align: center;
            font-size: 0.8rem;
            color: #7f8c8d;
            margin: 2rem 0;
        }
        .footer a {
            color: #7f8c8d;
            text-decoration: none;
        }
        .copyright {
            text-align: center;
            font-size: 0.7rem;
            color: #7f8c8d;
            margin-top: 0.5rem;
        }
        .search-info {
            background: white;
            color: #000;
            padding: 1.5rem;
            border: 2px solid #000;
            border-radius: 10px;
            margin-bottom: 2rem;
            text-align: center;
        }
        @media screen {
            .search-info {
                background: #34495e;
                color: white;
                border: none;
            }
        }
        @media print {
            body { background: white; }
            .header, .book-list, .footer { box-shadow: none; }
            .print-section { display: none; }
            .copyright { display: none; }
        }
        @media (max-width: 600px) {
            body {
                padding: 2rem 0.8rem 1rem 0.8rem;
                background: white;
            }
            .header {
                margin-bottom: 1.5rem;
            }
            .search-info {
                padding: 1rem;
                font-size: 0.9rem;
            }
            .footer {
                margin: 1rem 0;
            }
            .copyright {
                margin-top: 0.25rem;
            }
            .book-list {
                background: transparent;
                padding: 0;
                margin-bottom: 1rem;
                box-shadow: none;
            }
            .book-item {
                padding: 1rem 0;
                gap: 0.25rem;
            }
            .book-number {
                min-width: 20px;
                flex-shrink: 0;
            }
            .book-content {
                flex: 1;
                min-width: 0;
            }
            .book-meta,
            .book-recommendation {
                margin-left: -20px;
            }
            .print-btn {
                font-size: 1rem;
                padding: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">ğŸ“š íŠ¸ë¦¬ìš°ìŠ¤ ë„ì„œ ê²€ìƒ‰ê²°ê³¼</div>
        <div class="subtitle">Trius Books Search Results</div>
    </div>
    
    <div class="search-info">
        "<strong>${currentSearchQuery}</strong>" í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•˜ì‹  ë„ì„œê°€<br class="mobile-break">
        ${dateStr} ê¸°ì¤€, ì´ <strong>${filteredBooks.length}ê¶Œ</strong>ì´ ìˆë„¤ìš”.<br>
        <strong style="color: #e74c3c;">ë¶„ë¥˜ë²ˆí˜¸</strong>ë¥¼ ë©”ëª¨í•˜ë©´ ì±… ì°¾ê¸°ê°€ ìˆ˜ì›”í•  ê±°ì˜ˆìš”.
    </div>
    
    <div class="book-list">`;

            filteredBooks.forEach((book, index) => {
                content += `
        <div class="book-item">
            <div class="book-number">${index + 1}.</div>
            <div class="book-content">
                <div class="book-title">${book['ë„ì„œëª…'] || ''}</div>
                <div class="book-meta">
                    ì €ì: <strong>${book['ì €ì'] || ''}</strong> | 
                    ë¶„ë¥˜: <strong>${book['ë¶„ë¥˜'] || ''}</strong> | 
                    ë¶„ë¥˜ë²ˆí˜¸: <span style="color: #e74c3c; font-weight: bold;">${book['ë¶„ë¥˜ë²ˆí˜¸'] || ''}</span>
                </div>
                <div class="book-recommendation">
                    ${book['ì¶”ì²œ ëŒ€ìƒ'] || ''}
                </div>
            </div>
        </div>`;
            });

            content += `
    </div>
    
    <div class="footer">
        ë³¸ ë„ì„œëª©ë¡ì€ ì…ì£¼ë¯¼ í¸ì˜ë¥¼ ìœ„í•´ ê°œì¸ì ìœ¼ë¡œ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.<br>
        ì œì•ˆì´ë‚˜ ë©”ì‹œì§€ëŠ” <a href="mailto:dooook@gmail.com">dooook@gmail.com</a> ìœ¼ë¡œ ë³´ë‚´ì£¼ì„¸ìš”.
    </div>
    
    <div class="copyright">
        Â© 2025 Agnes Legrand. All rights reserved.
    </div>
</body>
</html>`;

            return content;
        }

        // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
        function showPreviewModal() {
            const modal = document.getElementById('preview-modal');
            const previewContent = document.getElementById('preview-content');

            // HTML ìƒì„±
            const htmlContent = generateDownloadHTML();

            // iframeìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ (ì „ì²´ ë†’ì´)
            previewContent.innerHTML = `
                <iframe 
                    srcdoc="${htmlContent.replace(/"/g, '&quot;')}" 
                    style="width: 100%; height: 100%; border: none;"
                ></iframe>
            `;

            // ëª¨ë‹¬ í‘œì‹œ
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸°
        function closePreviewModal() {
            const modal = document.getElementById('preview-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // ë‹¤ìš´ë¡œë“œ í™•ì¸
        function confirmDownload() {
            const htmlContent = generateDownloadHTML();
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');

            const today = new Date();
            a.href = url;
            a.download = `íŠ¸ë¦¬ìš°ìŠ¤ë„ì„œê²€ìƒ‰_${currentSearchQuery}_${String(today.getFullYear()).slice(-2)}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}.html`;
            document.body.appendChild(a);
            a.click();

            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            // ì„±ê³µ ì•Œë¦¼ ëª¨ë‹¬
            closePreviewModal();
            showModal('íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°
        function printPreview() {
            const htmlContent = generateDownloadHTML();
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.print();

            closePreviewModal();
        }

        // ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì•Œë¦¼ ëª¨ë‹¬
        function showModal(message, type = 'info') {
            const icons = {
                success: 'âœ…',
                warning: 'âš ï¸',
                error: 'âŒ',
                info: 'â„¹ï¸'
            };

            const modal = document.createElement('div');
            modal.className = `notification - modal ${type} `;
            modal.innerHTML = `
            < div class="notification-content" >
                    <span class="notification-icon">${icons[type]}</span>
                    <span class="notification-message">${message}</span>
                </div >
            `;

            document.body.appendChild(modal);

            setTimeout(() => {
                modal.classList.add('fade-out');
                setTimeout(() => modal.remove(), 300);
            }, 2500);
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ ìƒì„±
        function createPagination(totalPages) {
            const container = document.getElementById('pagination-container');

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let paginationHtml = '<div class="pagination">';

            // ì´ì „ ë²„íŠ¼
            if (currentPage > 1) {
                paginationHtml += `<button class="page-btn" onclick="goToPage(${currentPage - 1})">â—€ ì´ì „</button>`;
            }

            // í˜ì´ì§€ ë²ˆí˜¸ ê³„ì‚°
            const maxVisiblePages = 7;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // ëë¶€ë¶„ì—ì„œ ì‹œì‘ì  ì¡°ì •
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // ì²« í˜ì´ì§€ í‘œì‹œ
            if (startPage > 1) {
                paginationHtml += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHtml += '<span class="page-dots">...</span>';
                }
            }

            // í˜ì´ì§€ ë²ˆí˜¸ë“¤
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? ' active' : '';
                paginationHtml += `<button class="page-btn${activeClass}" onclick="goToPage(${i})">${i}</button>`;
            }

            // ë§ˆì§€ë§‰ í˜ì´ì§€ í‘œì‹œ
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHtml += '<span class="page-dots">...</span>';
                }
                paginationHtml += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }

            // ë‹¤ìŒ ë²„íŠ¼
            if (currentPage < totalPages) {
                paginationHtml += `<button class="page-btn" onclick="goToPage(${currentPage + 1})">ë‹¤ìŒ â–¶</button>`;
            }

            paginationHtml += '</div>';
            container.innerHTML = paginationHtml;
        }

        // í˜ì´ì§€ ì´ë™
        function goToPage(page) {
            currentPage = page;
            displayBooksWithPagination();

            // í˜ì´ì§€ ë³€ê²½ ì‹œ í™•ì¥ëœ ì¶”ì²œëŒ€ìƒ ë‹«ê¸°
            closeRecommendation();

            // í…Œì´ë¸” ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            document.querySelector('.books-list').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>

</html>